<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>WEB-STRIKE: TITAN ELITE [FINAL]</title>
    <style>
        :root { --primary: #eebc51; --bg: #0b0c0e; --hud-bg: rgba(10, 15, 20, 0.9); }
        body, html { margin: 0; padding: 0; overflow: hidden; background: var(--bg); font-family: 'Courier New', monospace; color: white; }
        #vignette { position: fixed; inset: 0; pointer-events: none; z-index: 100; box-shadow: inset 0 0 150px rgba(0,0,0,0.9); }
        #hud { position: fixed; inset: 0; pointer-events: none; z-index: 50; display: none; }
        .skew { transform: skewX(-10deg); background: var(--hud-bg); border-left: 4px solid var(--primary); padding: 10px 20px; position: absolute; }
        #health-info { bottom: 20px; left: 20px; }
        #score-info { top: 20px; left: 20px; }
        #weapon-info { bottom: 20px; right: 20px; text-align: right; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; transform: translate(-50%, -50%); }
        #crosshair::before, #crosshair::after { content: ''; position: absolute; background: var(--primary); }
        #crosshair::before { width: 2px; height: 100%; left: 9px; }
        #crosshair::after { height: 2px; width: 100%; top: 9px; }
        #menu { position: fixed; inset: 0; z-index: 150; background: radial-gradient(circle, #1a2533 0%, #0b0c0e 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn { border: 2px solid var(--primary); color: var(--primary); padding: 20px 60px; cursor: pointer; font-weight: bold; letter-spacing: 3px; }
        .btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 30px var(--primary); }
    </style>
</head>
<body>

<div id="vignette"></div>
<div id="menu">
    <h1 style="color: var(--primary); font-size: 3.5rem; margin: 0;">WEB-STRIKE</h1>
    <p style="letter-spacing: 5px; margin-bottom: 40px;">TITAN ELITE PROTOCOL</p>
    <div class="btn" onclick="startGame()">DESPLEGAR</div>
</div>

<div id="hud">
    <div id="score-info" class="skew">BAJAS: <span id="kill-count">0</span></div>
    <div id="health-info" class="skew">VITALIDAD: <span id="hp-display">100</span>%</div>
    <div id="weapon-info" class="skew">MODELO: AK-47 v2<br>MUNICIÓN: ILIMITADA</div>
    <div id="crosshair"></div>
</div>

<script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';

    // --- AUDIO & TEXTURAS ---
    class Engine {
        static ctx = new (window.AudioContext || window.webkitAudioContext)();
        static play(f, t, d) {
            const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, this.ctx.currentTime);
            g.gain.setValueAtTime(0.1, this.ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + d);
            o.connect(g); g.connect(this.ctx.destination);
            o.start(); o.stop(this.ctx.currentTime + d);
        }
    }

    let scene, camera, renderer, clock, raycaster;
    let playerHP = 100, kills = 0, gunGroup;
    let enemies = [], obstacles = [], medkits = [];
    const move = { w: false, s: false, a: false, d: false };
    const velocity = new THREE.Vector3();

    function init() {
        scene = new THREE.Scene();
        scene.fog = new THREE.Fog(0x0b0c0e, 0, 70);
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        
        renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        clock = new THREE.Clock();
        raycaster = new THREE.Raycaster();

        // Escenario
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({color: 0x151515}));
        floor.rotation.x = -Math.PI/2;
        scene.add(floor);
        scene.add(new THREE.AmbientLight(0xffffff, 0.4));
        const sun = new THREE.PointLight(0xeebc51, 150); sun.position.set(0,15,0); scene.add(sun);

        // Crear Muros y Cajas
        for(let i=0; i<15; i++) {
            const h = Math.random() * 4 + 2;
            const wall = new THREE.Mesh(new THREE.BoxGeometry(4, h, 4), new THREE.MeshStandardMaterial({color: 0x333333}));
            wall.position.set((Math.random()-0.5)*60, h/2, (Math.random()-0.5)*60);
            scene.add(wall);
            obstacles.push(wall);
        }

        buildGun();
        setupControls();
        setInterval(spawnEnemy, 2500);
        animate();
    }

    function buildGun() {
        gunGroup = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.2, 0.8), new THREE.MeshStandardMaterial({color: 0x222}));
        const barrel = new THREE.Mesh(new THREE.CylinderGeometry(0.03, 0.03, 0.6), new THREE.MeshStandardMaterial({color: 0x111}));
        barrel.rotation.x = Math.PI/2; barrel.position.z = -0.5;
        const grip = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.3, 0.15), new THREE.MeshStandardMaterial({color: 0x3d2b1f}));
        grip.position.set(0, -0.2, -0.1);
        gunGroup.add(body, barrel, grip);
        gunGroup.position.set(0.4, -0.4, -0.6);
        camera.add(gunGroup);
        scene.add(camera);
    }

    function spawnEnemy() {
        const mesh = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2.2, 1.2), new THREE.MeshStandardMaterial({color: 0xff3333, emissive: 0xff0000, emissiveIntensity: 0.2}));
        const a = Math.random() * Math.PI * 2;
        mesh.position.set(Math.cos(a)*40, 1.1, Math.sin(a)*40);
        mesh.userData = { isEnemy: true };
        scene.add(mesh);
        enemies.push(mesh);
    }

    function setupControls() {
        window.startGame = () => { document.getElementById('menu').style.display='none'; document.getElementById('hud').style.display='block'; document.body.requestPointerLock(); };
        document.addEventListener('keydown', (e) => move[e.key.toLowerCase()] = true);
        document.addEventListener('keyup', (e) => move[e.key.toLowerCase()] = false);
        document.addEventListener('mousemove', (e) => {
            if(document.pointerLockElement) {
                camera.rotation.y -= e.movementX * 0.002;
                camera.rotation.x = Math.max(-1.4, Math.min(1.4, camera.rotation.x - e.movementY * 0.002));
            }
        });
        document.addEventListener('mousedown', () => {
            if(!document.pointerLockElement) return;
            Engine.play(180, 'sawtooth', 0.1);
            gunGroup.position.z += 0.1; // Kickback
            
            raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = raycaster.intersectObjects(scene.children);
            if(hits.length > 0 && hits[0].object.userData.isEnemy) {
                scene.remove(hits[0].object);
                enemies = enemies.filter(e => e !== hits[0].object);
                kills++; document.getElementById('kill-count').innerText = kills;
                Engine.play(80, 'square', 0.2);
            }
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        const delta = clock.getDelta();
        if(!document.pointerLockElement) return;

        // Movimiento e inercia del arma
        velocity.set(0,0,0);
        if(move.w) velocity.z -= 12 * delta; if(move.s) velocity.z += 12 * delta;
        if(move.a) velocity.x -= 12 * delta; if(move.d) velocity.x += 12 * delta;
        camera.translateX(velocity.x); camera.translateZ(velocity.z);
        camera.position.y = 1.7;

        // Balanceo y retroceso del arma
        gunGroup.position.z = THREE.MathUtils.lerp(gunGroup.position.z, -0.6, 0.1);
        gunGroup.position.y = -0.4 + Math.sin(Date.now() * 0.005) * 0.01;

        // IA Enemiga
        enemies.forEach(en => {
            const dir = new THREE.Vector3().subVectors(camera.position, en.position).normalize();
            en.position.add(new THREE.Vector3(dir.x, 0, dir.z).multiplyScalar(4 * delta));
            en.lookAt(camera.position.x, 1.1, camera.position.z);
            if(en.position.distanceTo(camera.position) < 1.8) {
                playerHP -= 0.3;
                document.getElementById('vignette').style.boxShadow = "inset 0 0 150px rgba(255,0,0,0.7)";
                setTimeout(() => document.getElementById('vignette').style.boxShadow = "inset 0 0 150px rgba(0,0,0,0.9)", 50);
            }
        });

        if(playerHP <= 0) { alert("OPERACIÓN FALLIDA. BAJAS: " + kills); location.reload(); }
        document.getElementById('hp-display').innerText = Math.floor(playerHP);
        renderer.render(scene, camera);
    }
    init();
</script>
</body>
</html>